# 템플릿 매칭 알고리즘

> 다중 후보 중 가장 적절한 템플릿을 선택하는 방법

## 1. 매칭 파이프라인

```
요청: "WMS 도입 프로젝트 4단계를 타임라인으로 보여줘"
    │
    ▼
┌─────────────────────────────────────────────────┐
│ Step 1: 규칙 기반 필터링                          │
│ • pattern: timeline-*                           │
│ • element_count: 4 포함                         │
│ → 후보: dongkuk, tipgreen, samsung, common      │
└─────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────┐
│ Step 2: LLM 시맨틱 매칭                          │
│ • 발표 맥락과 semantic_description 비교          │
│ • 테마 색상과 colors.palette_type 비교           │
│ • 청중/목적과 recommended_for 비교              │
│ • 썸네일 시각적 비교 (선택)                       │
│                                                 │
│ → 선택: tipgreen/timeline-01                    │
└─────────────────────────────────────────────────┘
```

## 2. 선택 우선순위

| 순위 | 조건 | 가중치 |
|------|------|--------|
| 1 | 문서 양식 명시적 지정 | 최우선 |
| 2 | 테마 색상 계열 일치 | 높음 |
| 3 | 청중/목적 적합성 | 높음 |
| 4 | 스타일 분위기 유사 | 중간 |
| 5 | 시맨틱 설명 유사도 | 중간 |
| 6 | 범용 템플릿 (document_style: null) | 낮음 |

## 3. LLM 프롬프트 예시

```
[System]
다음 템플릿 후보 중 요청에 가장 적합한 것을 선택하세요.

[요청 컨텍스트]
- 발표 주제: WMS 도입 프로젝트
- 발표 대상: 경영진 (executive)
- 테마: 딥그린 (palette: green)
- 필요 요소 개수: 4개

[후보 템플릿]
1. dongkuk/timeline-01
   - palette_type: blue
   - recommended_for.audiences: [executive]
   - style.mood: classic
   - semantic_description: 깔끔한 화살표 연결, 파란 계열, 기업용

2. tipgreen/timeline-01
   - palette_type: green ✅
   - recommended_for.audiences: [executive] ✅
   - style.mood: modern
   - semantic_description: 둥근 원형 노드, 녹색 그라디언트, 모던

3. samsung/timeline-01
   - palette_type: gray
   - recommended_for.audiences: [executive] ✅
   - style.mood: minimal
   - semantic_description: 직선 연결, 미니멀, 그레이 톤

[응답 형식]
{
  "selected": "tipgreen/timeline-01",
  "reason": "딥그린 테마와 색상 조화가 좋고, 모던한 스타일이 기술 프로젝트에 적합",
  "score": 0.92
}
```

## 4. 스코어링 로직 (참고용)

```python
def calculate_match_score(template, context):
    score = 0.0
    
    # 색상 팔레트 일치 (0.3)
    if template.colors.palette_type == context.theme.palette_type:
        score += 0.3
    
    # 청중 일치 (0.25)
    if context.audience in template.recommended_for.audiences:
        score += 0.25
    
    # 목적 일치 (0.25)
    if context.purpose in template.recommended_for.purposes:
        score += 0.25
    
    # 스타일 분위기 (0.1)
    if template.style.mood == context.desired_mood:
        score += 0.1
    
    # 시맨틱 유사도 (0.1) - LLM 판단
    score += semantic_similarity(template.semantic_description, context.request) * 0.1
    
    return score
```

## 5. Fallback 전략

| 상황 | 동작 |
|------|------|
| 매칭 후보 0개 | LLM이 semantic 기반으로 새 HTML 생성 |
| 매칭 후보 1개 | 해당 템플릿 사용 |
| 매칭 후보 다수 | LLM 시맨틱 매칭으로 선택 |
| 모든 스코어 0.5 미만 | 범용 템플릿 또는 새로 생성 |
