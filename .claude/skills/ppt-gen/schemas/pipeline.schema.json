{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "pipeline.schema.json",
  "title": "PPT Generation Pipeline State",
  "description": "PPT 생성 파이프라인 상태 스키마 - 슬라이드별 플랫 구조 (v5.3 - 디자인 정보 확장)",
  "type": "object",
  "required": ["session", "current_stage"],
  "properties": {
    "session": {
      "type": "object",
      "required": ["id", "title", "created_at", "status"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}_\\d{6}_[a-z0-9][a-z0-9-]*$",
          "description": "세션 ID: YYYY-MM-DD_HHMMSS_name (예: 2026-01-09_134636_project-plan)"
        },
        "title": { "type": "string" },
        "created_at": { "type": "string", "format": "date-time" },
        "updated_at": { "type": "string", "format": "date-time" },
        "status": { "enum": ["in_progress", "paused", "completed", "failed"] }
      }
    },
    "current_stage": {
      "type": "integer",
      "minimum": 1,
      "maximum": 5,
      "description": "1=Setup, 2=Outline, 3=Matching, 4=Content, 5=Generation"
    },
    "setup": {
      "type": "object",
      "description": "1단계: 전역 설정",
      "properties": {
        "presentation": {
          "type": "object",
          "properties": {
            "title": { "type": "string" },
            "topic": { "type": "string" },
            "audience": { "type": "string" },
            "purpose": { "type": "string" },
            "document_type": { "type": "string" },
            "duration_minutes": { "type": "integer" },
            "estimated_slides": { "type": "integer" }
          }
        },
        "theme": {
          "type": "object",
          "properties": {
            "id": { "type": "string" },
            "colors": { "type": "object" }
          }
        }
      }
    },
    "slides": {
      "type": "array",
      "description": "슬라이드별 플랫 데이터 (2~5단계 누적)",
      "items": {
        "type": "object",
        "required": ["index"],
        "properties": {
          "index": { "type": "integer" },

          "title": { "type": "string", "description": "2단계: 슬라이드 제목" },
          "purpose": { "type": "string", "description": "2단계: 슬라이드 목적 (cover, toc, content...)" },
          "key_points": { "type": "array", "items": { "type": "string" }, "description": "2단계: 핵심 포인트" },
          "speaker_notes": { "type": "string", "description": "2단계: 발표자 노트" },

          "template_id": { "type": ["string", "null"], "description": "3단계: 매칭된 템플릿 ID" },
          "object_id": { "type": ["string", "null"], "description": "3단계: 매칭된 오브젝트 ID" },
          "match_score": { "type": "number", "description": "3단계: 매칭 점수" },
          "layout": {
            "type": "object",
            "description": "3단계: 레이아웃 정보",
            "properties": {
              "type": { "type": "string" },
              "columns": { "type": "integer" }
            }
          },

          "html_file": { "type": "string", "description": "4단계: HTML 파일 (HTML 방식)" },
          "assets": {
            "type": "object",
            "description": "4단계: 에셋 (SVG는 정적 그래픽으로만)",
            "properties": {
              "icons": { "type": "array", "items": { "type": "string" } },
              "images": { "type": "array", "items": { "type": "string" } },
              "backgrounds": { "type": "array", "items": { "type": "string" } }
            }
          },
          "text_content": {
            "type": "object",
            "description": "4단계: 텍스트 콘텐츠",
            "properties": {
              "headline": { "type": "string" },
              "subheadline": { "type": "string" },
              "body": { "type": "string" }
            }
          },
          "ooxml_bindings": {
            "type": "object",
            "description": "4단계: OOXML 바인딩 (문서양식 편집용)",
            "properties": {
              "template": { "type": "string", "description": "OOXML 템플릿 경로" },
              "mappings": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": ["id", "type", "value"],
                  "properties": {
                    "id": { "type": "string", "description": "Shape ID" },
                    "type": { "enum": ["text", "image", "color"], "description": "바인딩 타입" },
                    "value": { "type": "string", "description": "바인딩 값" }
                  }
                }
              }
            }
          },

          "content_bindings": {
            "type": ["object", "null"],
            "description": "4단계: 구조화된 콘텐츠 바인딩 (v5.3 NEW)",
            "properties": {
              "title": { "type": "string", "description": "슬라이드 제목" },
              "subtitle": { "type": ["string", "null"], "description": "부제목" },
              "items": {
                "type": "array",
                "description": "카드/아이템 배열 (cards, steps, features 등)",
                "items": {
                  "type": "object",
                  "properties": {
                    "number": { "type": "string" },
                    "title": { "type": "string" },
                    "subtitle": { "type": "string" },
                    "description": { "type": "string" },
                    "features": { "type": "array", "items": { "type": "string" } },
                    "icon": { "type": "string" },
                    "image": { "type": "string" }
                  }
                }
              },
              "table": {
                "type": "object",
                "description": "테이블 데이터",
                "properties": {
                  "headers": { "type": "array", "items": { "type": "string" } },
                  "rows": { "type": "array", "items": { "type": "array" } }
                }
              },
              "footer": {
                "type": "object",
                "properties": {
                  "page_number": { "type": "string" },
                  "project_name": { "type": "string" }
                }
              },
              "highlight": { "type": "string", "description": "강조 텍스트" }
            }
          },

          "generated": { "type": "boolean", "description": "5단계: 생성 완료 여부" },
          "pptx_slide_index": { "type": "integer", "description": "5단계: PPTX 내 슬라이드 인덱스" },

          "design_info": {
            "type": ["object", "null"],
            "description": "5단계: 완전한 디자인 정보 (v5.3 NEW)",
            "properties": {
              "layout": {
                "type": "object",
                "description": "레이아웃 정보",
                "properties": {
                  "type": { "enum": ["grid", "radial", "sequential", "freeform", "split", "centered"] },
                  "grid": {
                    "type": "object",
                    "properties": {
                      "columns": { "type": "integer" },
                      "rows": { "type": "integer" },
                      "column_weights": { "type": "array", "items": { "type": "number" } }
                    }
                  },
                  "direction": { "enum": ["horizontal", "vertical"] }
                }
              },
              "zones": {
                "type": "array",
                "description": "콘텐츠 영역 정의",
                "items": {
                  "type": "object",
                  "properties": {
                    "id": { "type": "string" },
                    "role": { "enum": ["slide_title", "subtitle", "main_content", "sidebar", "footer", "header", "decoration"] },
                    "geometry": {
                      "type": "object",
                      "properties": {
                        "x": { "type": "number", "description": "pt 단위" },
                        "y": { "type": "number" },
                        "cx": { "type": "number", "description": "width in pt" },
                        "cy": { "type": "number", "description": "height in pt" }
                      }
                    },
                    "placeholder_type": { "enum": ["TITLE", "BODY", "DIAGRAM", "PICTURE", "TABLE", "CHART"] },
                    "element_type": { "type": "string", "description": "card-grid, timeline, process 등" },
                    "element_count": { "type": "integer" }
                  }
                }
              },
              "shapes_summary": {
                "type": "object",
                "description": "도형 요약",
                "properties": {
                  "total_count": { "type": "integer" },
                  "by_type": {
                    "type": "object",
                    "additionalProperties": { "type": "integer" }
                  },
                  "patterns": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "type": { "type": "string", "description": "numbered_card, icon_card 등" },
                        "count": { "type": "integer" },
                        "elements": { "type": "array", "items": { "type": "string" } }
                      }
                    }
                  }
                }
              },
              "color_tokens": {
                "type": "object",
                "description": "사용된 색상 토큰 (HEX 값)",
                "additionalProperties": { "type": "string" }
              },
              "typography": {
                "type": "object",
                "description": "타이포그래피 정보",
                "additionalProperties": {
                  "type": "object",
                  "properties": {
                    "font_size_pt": { "type": "number" },
                    "font_weight": { "enum": ["normal", "bold", "light"] },
                    "font_color": { "type": "string" },
                    "line_height": { "type": "number" }
                  }
                }
              },
              "spacing": {
                "type": "object",
                "description": "간격 정보 (pt 단위)",
                "properties": {
                  "slide_margin": {
                    "type": "object",
                    "properties": {
                      "top": { "type": "number" },
                      "right": { "type": "number" },
                      "bottom": { "type": "number" },
                      "left": { "type": "number" }
                    }
                  },
                  "section_gap": { "type": "number" },
                  "item_gap": { "type": "number" },
                  "card_padding": { "type": "number" }
                }
              },
              "constraints": {
                "type": "object",
                "description": "제약 조건",
                "properties": {
                  "max_items": { "type": "integer" },
                  "min_items": { "type": "integer" },
                  "title_max_chars": { "type": "integer" },
                  "description_max_lines": { "type": "integer" }
                }
              },
              "visual_properties": {
                "type": "object",
                "description": "시각적 속성",
                "properties": {
                  "balance": { "enum": ["symmetric", "asymmetric"] },
                  "hierarchy": { "type": "integer", "description": "시각적 계층 수" },
                  "emphasis_style": { "enum": ["numbered", "icon", "color", "size"] }
                }
              }
            }
          },

          "slide_stage": {
            "type": "integer",
            "minimum": 2,
            "maximum": 5,
            "description": "슬라이드별 현재 스테이지 (v5.3 NEW - 수정 루프 지원)"
          },
          "revision": {
            "type": "integer",
            "minimum": 0,
            "description": "수정 횟수 (0 = 최초 생성) (v5.3 NEW)"
          },
          "revision_history": {
            "type": "array",
            "description": "수정 이력 (선택적) (v5.3 NEW)",
            "items": {
              "type": "object",
              "properties": {
                "revision": { "type": "integer" },
                "template_id": { "type": "string" },
                "timestamp": { "type": "string", "format": "date-time" },
                "reason": { "type": "string", "description": "수정 사유" }
              }
            }
          },

          "evaluation": {
            "type": ["object", "null"],
            "description": "4단계: 디자인 평가 결과 (v5.7 NEW)",
            "properties": {
              "attempt_number": {
                "type": "integer",
                "minimum": 1,
                "maximum": 3,
                "description": "현재 시도 횟수"
              },
              "current_score": {
                "type": "number",
                "minimum": 0,
                "maximum": 100,
                "description": "현재 평가 점수"
              },
              "passed": {
                "type": "boolean",
                "description": "합격 여부 (≥70)"
              },
              "selected_reason": {
                "enum": ["passed", "best_of_3"],
                "description": "선택 사유: passed=70점 이상 합격, best_of_3=3회 실패 후 최고 점수 선택"
              },
              "details": {
                "type": "object",
                "description": "카테고리별 세부 점수",
                "properties": {
                  "layout": { "$ref": "#/$defs/categoryScore" },
                  "typography": { "$ref": "#/$defs/categoryScore" },
                  "color": { "$ref": "#/$defs/categoryScore" },
                  "content_fit": { "$ref": "#/$defs/categoryScore" },
                  "visual": { "$ref": "#/$defs/categoryScore" }
                }
              },
              "critical_failures": {
                "type": ["array", "null"],
                "items": {
                  "enum": ["overflow", "contrast_failure", "element_count_mismatch", "content_missing"]
                },
                "description": "자동 불합격 사유"
              }
            }
          },

          "attempt_history": {
            "type": "array",
            "description": "디자인 평가 시도 이력 (v5.7 NEW)",
            "items": {
              "type": "object",
              "properties": {
                "attempt": { "type": "integer", "minimum": 1, "maximum": 3 },
                "template_id": { "type": "string" },
                "html_file": { "type": "string" },
                "score": { "type": "number", "minimum": 0, "maximum": 100 },
                "passed": { "type": "boolean" },
                "critical_failures": {
                  "type": ["array", "null"],
                  "items": { "type": "string" }
                },
                "issues": {
                  "type": "array",
                  "items": { "type": "string" },
                  "description": "발견된 문제점"
                },
                "timestamp": { "type": "string", "format": "date-time" }
              },
              "required": ["attempt", "template_id", "score", "passed", "timestamp"]
            }
          }
        }
      }
    },
    "output": {
      "type": "object",
      "description": "5단계: 최종 출력",
      "properties": {
        "pptx_file": { "type": ["string", "null"] },
        "thumbnail_file": { "type": ["string", "null"] },
        "slide_count": { "type": "integer" },
        "completed_at": { "type": "string", "format": "date-time" }
      }
    }
  },

  "$defs": {
    "categoryScore": {
      "type": "object",
      "description": "디자인 평가 카테고리별 점수 (v5.7)",
      "properties": {
        "score": { "type": "number", "minimum": 0, "description": "획득 점수" },
        "max": { "type": "number", "description": "최대 점수" },
        "issues": {
          "type": "array",
          "items": { "type": "string" },
          "description": "발견된 문제점"
        }
      },
      "required": ["score", "max"]
    }
  }
}
